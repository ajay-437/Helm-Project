name: Build and Deploy

on:
  push:
    branches: [ main ]  # Trigger on pushes to the master branch (adjust as needed)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub (replace with secrets)
        run: |
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and tag Docker image (latest and versioned)
        run: |
          set -x
          docker build -t ajay437/test:latest .

          CURRENT_VERSION=$(docker images --format "{{.Tag}}" ajay437/test| grep -E '^[0-9]+\.[0-9]+$' | sort -r | head -n 1)

          if [ -z "$CURRENT_VERSION" ]; then
              NEW_VERSION="0.1"
          else
              IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
              MAJOR="${VERSION_PARTS[0]}"
              MINOR="${VERSION_PARTS[1]}"
              MINOR=$((MINOR + 1))
              NEW_VERSION="$MAJOR.$MINOR"
          fi

          docker tag ajay437/test:latest ajay437/test:$NEW_VERSION
          echo "New version tagged: ajay437/test:$NEW_VERSION"

      - name: Push Docker images (latest and versioned)
        run: |
          docker push ajay437/test:latest
          docker push ajay437/test:$NEW_VERSION

      - name: Checkout chart repository (replace with your location)
        uses: actions/checkout@v3
        with:
          repository: ajay-437/testchert

      - name: Update image tag in values.yaml (optional)
        run: |
          # This step assumes your values.yaml has an image tag variable
          # Adjust the sed command based on your actual configuration
          sed -i "s/image\.tag:.*/image\.tag: $NEW_VERSION/" testchert/values.yaml

      - name: Check for existing Helm installation
        run: |
          which helm >/dev/null 2>&1 && echo "Helm is installed" || echo "Helm is not installed"

      - name: Install Helm if missing
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/v3.9.3/scripts/get-helm.sh
          bash get_helm.sh

      - name: Connect to EKS cluster (replace with your cluster configuration)
        uses: aws-actions/eks-update-kubeconfig@v1
        with:
          region: ca-central-1  
          name: ed-eks-01     

      - name: Upgrade or Install with Helm
        run: |
          # Check for existing release
          helm ls -n myns | grep myrelease2 >/dev/null 2>&1 && helm upgrade --install myrelease2 ./testchart -n myns || helm install myrelease2 ./testchart -n myns
          # Update image tag and namespace based on your configuration
          helm upgrade --install myrelease2 ./testchart -n myns --set image.repository=ajay437/test --set image.tag=$NEW_VERSION
